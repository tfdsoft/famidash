void lvl_done_update();
void refresh_queue_screen();
void text_stuff();
void play_next_queue();
void update_text1();
void update_text2();
void update_text3();


CODE_BANK_PUSH("XCD_BANK_09")

const unsigned char state_soundtestscreen[468]={
0x01,0x02,0x01,0x04,0xae,0x02,0x01,0x13,0xae,0x02,0x01,0x09,0xaf,0x02,0x01,0x13,
0xaf,0x02,0x01,0x06,0x06,0x07,0x04,0x01,0x17,0x06,0x07,0x02,0x01,0x03,0x08,0x09,
0x05,0x01,0x17,0x08,0x09,0x02,0x01,0x03,0x0c,0xff,0x01,0x19,0x0d,0x02,0x01,0x03,
0x0c,0xff,0x01,0x09,0xed,0xf5,0xf3,0xe9,0xe3,0xff,0x01,0x0a,0x0d,0x02,0x01,0x03,
0x0c,0xff,0x01,0x02,0x5c,0xfe,0x01,0x11,0x5d,0xff,0x01,0x02,0x0d,0x02,0x01,0x03,
0x0c,0xff,0x6e,0xff,0xfe,0x01,0x13,0xff,0x6f,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,
0x7e,0xff,0xfe,0x01,0x13,0xff,0x7f,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,0x01,0x02,
0x6c,0xfe,0x01,0x11,0x6d,0xff,0x01,0x02,0x0d,0x02,0x01,0x03,0x0c,0xff,0x01,0x19,
0x0d,0x02,0x01,0x03,0x0c,0xff,0x01,0x04,0xef,0xf2,0xe9,0xe7,0xe9,0xee,0xe1,0xec,
0xff,0xe1,0xf2,0xf4,0xe9,0xf3,0xf4,0xff,0x01,0x05,0x0d,0x02,0x01,0x03,0x0c,0xff,
0x5c,0xfe,0x01,0x15,0x5d,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,0xfe,0x01,0x17,0xff,
0x0d,0x02,0x01,0x03,0x0c,0xff,0xfe,0x01,0x17,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,
0x6c,0xfe,0x01,0x15,0x6d,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,0x01,0x19,0x0d,0x02,
0x01,0x03,0x0c,0xff,0x01,0x06,0xe3,0xef,0xf6,0xe5,0xf2,0xe5,0xe4,0xff,0xe2,0xf9,
0xff,0x01,0x08,0x0d,0x02,0x01,0x03,0x0c,0xff,0x5c,0xfe,0x01,0x15,0x5d,0xff,0x0d,
0x02,0x01,0x03,0x0c,0xff,0xfe,0x01,0x17,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,0xfe,
0x01,0x17,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,0xfe,0x01,0x17,0xff,0x0d,0x02,0x01,
0x03,0x0c,0xff,0xfe,0x01,0x17,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,0x6c,0xfe,0x01,
0x15,0x6d,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,0x01,0x19,0x0d,0x02,0x01,0x03,0x0c,
0xff,0xff,0xf3,0xe5,0xec,0xe5,0xe3,0xf4,0xe0,0xff,0xf4,0xef,0xe7,0xe7,0xec,0xe5,
0xff,0xf0,0xec,0xe1,0xf9,0xec,0xe9,0xf3,0xf4,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,
0xff,0xf0,0xf2,0xe5,0xf3,0xf3,0xff,0xe1,0xff,0xf4,0xef,0xff,0xf0,0xec,0xe1,0xf9,
0xff,0xe0,0xff,0xf3,0xf4,0xef,0xf0,0xff,0xff,0x0d,0x02,0x01,0x03,0x0c,0xff,0x01,
0x03,0xf0,0xf2,0xe5,0xf3,0xf3,0xff,0xe2,0xff,0xf4,0xef,0xff,0xe5,0xf8,0xe9,0xf4,
0xff,0x01,0x06,0x0d,0x02,0x01,0x03,0x0a,0x0b,0x04,0x01,0x09,0x06,0x0e,0x0e,0x07,
0x04,0x01,0x09,0x0a,0x0b,0x02,0x01,0x05,0x05,0x01,0x09,0x08,0x05,0x05,0x09,0x05,
0x01,0x09,0x02,0x01,0x03,0xff,0x5c,0x5f,0x01,0x03,0x53,0xff,0x77,0x00,0x01,0x05,
0xdd,0x77,0x00,0x01,0x05,0xdd,0x77,0x00,0x01,0x05,0xdd,0x77,0x00,0x01,0x05,0xdd,
0x77,0x00,0x01,0x05,0xdd,0x77,0x00,0x01,0x05,0xdd,0x0f,0x05,0x05,0x0d,0x07,0x05,
0x05,0x0f,0x01,0x00
};



const unsigned char SoundQueue[416]={
0x01,0x02,0x01,0x04,0xae,0x02,0x01,0x13,0xae,0x02,0x01,0x09,0xaf,0x02,0x01,0x13,
0xaf,0x02,0x01,0x04,0x06,0x07,0x04,0x01,0x1b,0x06,0x07,0x08,0x09,0x05,0x01,0x1b,
0x08,0x09,0x0c,0xff,0x01,0x1d,0x0d,0x0c,0xff,0x01,0x0b,0xed,0xf5,0xf3,0xe9,0xe3,
0xff,0x01,0x0c,0x0d,0x0c,0xff,0x01,0x04,0x5c,0xfe,0x01,0x11,0x5d,0xff,0x01,0x04,
0x0d,0x0c,0xff,0x01,0x02,0x6e,0xff,0xfe,0x01,0x13,0xff,0x6f,0xff,0x01,0x02,0x0d,
0x0c,0xff,0x01,0x02,0x7e,0xff,0xfe,0x01,0x13,0xff,0x7f,0xff,0x01,0x02,0x0d,0x0c,
0xff,0x01,0x04,0x6c,0xfe,0x01,0x11,0x6d,0xff,0x01,0x04,0x0d,0x0c,0xff,0x01,0x1d,
0x0d,0x0c,0xff,0x01,0x07,0xf0,0xec,0xe1,0xf9,0xec,0xe9,0xf3,0xf4,0xff,0xf1,0xf5,
0xe5,0xf5,0xe5,0xff,0x01,0x07,0x0d,0x0c,0xff,0x5c,0xfe,0x01,0x19,0x5d,0xff,0x0d,
0x0c,0xff,0xfe,0x01,0x1b,0xff,0x0d,0x0c,0xff,0xfe,0x01,0x1b,0xff,0x0d,0x0c,0xff,
0xfe,0x01,0x1b,0xff,0x0d,0x0c,0xff,0xfe,0x01,0x1b,0xff,0x0d,0x0c,0xff,0xfe,0x01,
0x1b,0xff,0x0d,0x0c,0xff,0xfe,0x01,0x1b,0xff,0x0d,0x0c,0xff,0xfe,0x01,0x1b,0xff,
0x0d,0x0c,0xff,0xfe,0x01,0x1b,0xff,0x0d,0x0c,0xff,0xfe,0x01,0x1b,0xff,0x0d,0x0c,
0xff,0xfe,0x01,0x1b,0xff,0x0d,0x0c,0xff,0x6c,0xfe,0x01,0x19,0x6d,0xff,0x0d,0x0c,
0xff,0x01,0x03,0xf3,0xe5,0xec,0xe5,0xe3,0xf4,0xe0,0xff,0xf4,0xef,0xe7,0xe7,0xec,
0xe5,0xff,0xf0,0xec,0xe1,0xf9,0xec,0xe9,0xf3,0xf4,0xff,0x01,0x02,0x0d,0x0c,0xff,
0x01,0x03,0xf0,0xf2,0xe5,0xf3,0xf3,0xff,0xe1,0xff,0xf4,0xef,0xff,0xe1,0xe4,0xe4,
0xff,0xf4,0xef,0xff,0xf1,0xf5,0xe5,0xf5,0xe5,0xff,0x01,0x02,0x0d,0x0c,0xff,0x01,
0x03,0xf0,0xf2,0xe5,0xf3,0xf3,0xff,0xe2,0xff,0xf4,0xef,0xff,0xf2,0xe5,0xed,0xef,
0xf6,0xe5,0xff,0x01,0x08,0x0d,0x0c,0xff,0x01,0x03,0xf0,0xf2,0xe5,0xf3,0xf3,0xff,
0xf5,0xf0,0xff,0xf4,0xef,0xff,0xf3,0xeb,0xe9,0xf0,0xff,0xf4,0xef,0xff,0xee,0xe5,
0xf8,0xf4,0xff,0xff,0x0d,0x0a,0x0b,0x04,0x01,0x0b,0x06,0x0e,0x0e,0x07,0x04,0x01,
0x0b,0x0a,0x0b,0x02,0x02,0x05,0x01,0x0b,0x08,0x05,0x05,0x09,0x05,0x01,0x0b,0x02,
0x02,0x7f,0x5c,0x5f,0x01,0x03,0x53,0xdf,0x55,0x00,0x01,0x05,0x55,0x55,0x00,0x01,
0x05,0x55,0x11,0x00,0x01,0x05,0x44,0x11,0x00,0x01,0x05,0x44,0x11,0x00,0x01,0x05,
0x44,0x55,0x00,0x01,0x05,0x45,0x07,0x05,0x05,0x0d,0x07,0x05,0x05,0x0d,0x01,0x00
};


void unrle_bgm1() {
	vram_adr(NAMETABLE_A);
	vram_unrle(state_soundtestscreen);  
}
void unrle_bgm2() {
	vram_adr(NAMETABLE_A);
	vram_unrle(SoundQueue);  
}




CODE_BANK_POP()
CODE_BANK_PUSH("XCD_BANK_07")


void refreshmenu();
void refreshmenu_part2();
void code_checker();
void set_fun_settings();


#include "defines/charmap/bgm_charmap.h"
#include "music_soundTestTables.h"
#include "sfx_soundTestTables.h"


#include "defines/charmap/bgm_charmap.h"


void play_next_queue() {

			for (tmp1 = 0; tmp1 < MAX_SONG_QUEUE_SIZE; tmp1++) {		
				tmp2 = tmp1 + 1;
				music_queue[tmp1] = music_queue[tmp2];
			}

			music_queue[MAX_SONG_QUEUE_SIZE] = 0xFF;

			if (music_queue[0] != 0xFF) { music_play(xbgmlookuptable[music_queue[0]]); }
			else { famistudio_music_stop(); songplaying = 0; }
				
			//refresh_queue_screen();
			tmp4 = 0xFF;
}			


void check_if_music_stopped_huge() {
	if (!queuemode) {
		if (songplaying && famistudio_song_speed == 0x80) { music_play(xbgmlookuptable[song & 0x7F]); }
	}
	else {
		if (famistudio_song_speed == 0x80) {

			play_next_queue();

		}
	}
}	



void state_soundtest() {
  	famistudio_music_stop();
  	music_update();

	pal_bg(paletteMenu);

	crossPRGBankJump0(unrle_bgm1); 	
	update_text1();
	
	song = 0;
	temptemp6 = 0; 	
	#define sfx tmp4
	sfx = 0;
	settingvalue = 0;
//	menuMusicCurrentlyPlaying=0;
	
	ppu_on_all();
	pal_fade_in();
	
	while (1) {
		//rand8();
		ppu_wait_nmi();
		oam_clear();
		check_if_music_stopped_huge();
		 // read the first controller
		kandoframecnt++;
		if (kandoframecnt & 1 && mouse_timer) mouse_timer--;	
		if (tmp4) refresh_queue_screen();
		if (tmp5) {
			__A__ = idx16_load_hi_NOC(xbgmtextsCoveringArtist1, song);
			if (__A__) draw_padded_text(xbgmtextsCoveringArtist1[song & 0x7F], xbgmtextsCoveringArtist1Size[song & 0x7F], 14, NTADR_A(9, 19));
			else one_vram_buffer_horz_repeat('$', 15, NTADR_A(9, 19));
			__A__ = idx16_load_hi_NOC(xbgmtextsCoveringArtist2, song);
			if (__A__) draw_padded_text(xbgmtextsCoveringArtist2[song & 0x7F], xbgmtextsCoveringArtist2Size[song & 0x7F], 14, NTADR_A(9, 20));
			else one_vram_buffer_horz_repeat('$', 15, NTADR_A(9, 20));
			__A__ = idx16_load_hi_NOC(xbgmtextsCoveringArtist3, song);
			if (__A__) draw_padded_text(xbgmtextsCoveringArtist3[song & 0x7F], xbgmtextsCoveringArtist3Size[song & 0x7F], 14, NTADR_A(9, 21));
			else one_vram_buffer_horz_repeat('$', 15, NTADR_A(9, 21));
			__A__ = idx16_load_hi_NOC(xbgmtextsCoveringArtist4, song);
			if (__A__) draw_padded_text(xbgmtextsCoveringArtist4[song & 0x7F], xbgmtextsCoveringArtist4Size[song & 0x7F], 14, NTADR_A(9, 22));
			else one_vram_buffer_horz_repeat('$', 15, NTADR_A(9, 22));
			tmp5 = 0;
		}

	if (joypad1.press_right || joypad1.press_left) hold_timer = 0;
	if (joypad1.press_right || (joypad1.right && hold_timer >= 15)) { song++; temptemp6 = 0; if (song == song_max) {song = 0;} if (!queuemode) update_text1(); else update_text3(); hold_timer = 0;}
	if (joypad1.press_left || (joypad1.left && hold_timer >= 15)) { if (song == 0) {song = song_max - 1;} else song--; temptemp6 = 0; if (!queuemode) update_text1(); else update_text3();  hold_timer = 0;}

	if (!queuemode) {		//not queue mode
		if (joypad1.press_b) {
			tmp3--;			
			one_vram_buffer(' ', NTADR_A(11, 7));
			one_vram_buffer(' ', NTADR_A(11, 14));
			//menuMusicCurrentlyPlaying = 1;
			gameState = STATE_MENU;
			return;
		}
		if (joypad1.press_a) {
				if (!temptemp6) { music_play(xbgmlookuptable[song & 0x7F]); temptemp6 = 1; songplaying = 1; }
				else { famistudio_music_stop(); music_update(); temptemp6 = 0; songplaying = 0; }
		}					
		if (joypad1.press_select) { 
			ppu_off();
			crossPRGBankJump0(unrle_bgm2); 	   	
			ppu_on_all();
			queuemode = 1;
			update_text2();
			update_text3();
		}
	}
	else {					//queue mode
		if (joypad1.press_select) { 
			ppu_off();
			crossPRGBankJump0(unrle_bgm1);
			ppu_on_all();
			queuemode = 0;
			update_text1();
		}	
		if (joypad1.press_up) {
				play_next_queue();		//debug
		}
		if (joypad1.press_a) {
			if (music_queue[0] == 0xFF) { 
				music_play(xbgmlookuptable[song & 0x7F]); 
				music_queue[0] = song;
				update_text2();
			}
			else {
				for (tmp1 = 1; tmp1 < MAX_SONG_QUEUE_SIZE; tmp1++) {
					if (music_queue[tmp1] == 0xFF) {
						music_queue[tmp1] = song;
						break;
					}
				}
				if (music_queue[10] == 0xFF) update_text2();
			}
		}
		if (joypad1.press_b) {
			if (music_queue[0] == 0xFF) { }
			else if (music_queue[1] == 0xFF) { 
					music_queue[0] = 0xFF;
					refresh_queue_screen();
					tmp4 = 2;
					famistudio_music_stop();
					songplaying = 0;
			}
			else {
				for (tmp1 = MAX_SONG_QUEUE_SIZE - 1; tmp1--; tmp1 > 0) {
					if (music_queue[tmp1] != 0xFF) {
						music_queue[tmp1] = 0xFF;
						refresh_queue_screen();
						tmp4 = 2;
						break;
					}
				}
			}
		}
	}				
		
		// sound test codes
	if (hold_timer < 15) hold_timer++;	
	}
}


void refresh_queue_screen() {
	switch (tmp4) {

		case 1:
				update_text3();
				tmp4 = 3;
				break;
		case 0:
		case 0xFF:
		case 2:
			for (tmp1 = 0; tmp1 < 4; tmp1++) {			//limited to 5??
			one_vram_buffer_horz_repeat('$', 27, NTADR_A(3, (13 + (tmp1))));		
			if (music_queue[tmp1] != 0xFF) {
				tmp3 = music_queue[tmp1];
				__A__ = idx16_load_hi_NOC(xbgmtextsUpper, tmp3);
				if (__A__) { 
					multi_vram_buffer_horz(xbgmtextsUpper[tmp3 & 0x7F], xbgmtextsUpperSize[tmp3 & 0x7F], NTADR_A(3, (13 + (tmp1))));
					multi_vram_buffer_horz(xbgmtextsLower[tmp3 & 0x7F], xbgmtextsLowerSize[tmp3 & 0x7F], NTADR_A((4 + xbgmtextsUpperSize[tmp3 & 0x7F]), (13 + (tmp1))));
				} else {
					multi_vram_buffer_horz(xbgmtextsLower[tmp3 & 0x7F], xbgmtextsLowerSize[tmp3 & 0x7F], NTADR_A(3, (13 + (tmp1))));
					one_vram_buffer_horz_repeat('$', 7, NTADR_A((3 + xbgmtextsLowerSize[tmp3 & 0x7F]), (13 + (tmp1))));
				}				
			} else one_vram_buffer_horz_repeat('$', 27, NTADR_A(3, (13 + (tmp1))));	
			tmp4 = 1;
			}
			break;
		case 3:
			for (tmp1 = 4; tmp1 < 8; tmp1++) {			//limited to 5??
			one_vram_buffer_horz_repeat('$', 27, NTADR_A(3, (13 + (tmp1))));	
			if (music_queue[tmp1] != 0xFF) {
				text_stuff();			
			}
			else one_vram_buffer_horz_repeat('$', 27, NTADR_A(3, (13 + (tmp1))));	
			tmp4 = 5;
			}
			break;
//		case 4:
//			for (tmp1 = 6; tmp1 < 8; tmp1++) {			//limited to 5??
//			one_vram_buffer_horz_repeat('$', 27, NTADR_A(3, (13 + (tmp1))));	
//			if (music_queue[tmp1] != 0xFF) {
//				text_stuff();			
//			}
//			else one_vram_buffer_horz_repeat('$', 27, NTADR_A(3, (13 + (tmp1))));	
//			tmp4 = 5;
//			}
//			break;
		case 5:
			for (tmp1 = 8; tmp1 < 10; tmp1++) {			//limited to 5??
			one_vram_buffer_horz_repeat('$', 27, NTADR_A(3, (13 + (tmp1))));	
			if (music_queue[tmp1] != 0xFF) {
				text_stuff();			
			}
			else one_vram_buffer_horz_repeat('$', 27, NTADR_A(3, (13 + (tmp1))));	
			}
			tmp4 = 0;
			break;
	};
			
}					

//CODE_BANK_POP()





void update_text1() {
	__A__ = idx16_load_hi_NOC(xbgmtextsUpper, song);
	if (__A__) draw_padded_text(xbgmtextsUpper[song & 0x7F], xbgmtextsUpperSize[song & 0x7F], 14, NTADR_A(9, 7));
	else one_vram_buffer_horz_repeat('$', 15, NTADR_A(9, 7));
	__A__ = idx16_load_hi_NOC(xbgmtextsLower, song);
	if (__A__) draw_padded_text(xbgmtextsLower[song & 0x7F], xbgmtextsLowerSize[song & 0x7F], 14, NTADR_A(9, 8));
	else one_vram_buffer_horz_repeat('$', 15, NTADR_A(9, 8));
	
	__A__ = idx16_load_hi_NOC(xbgmtextsLowerOrigArtist, song);
	if (__A__) draw_padded_text(xbgmtextsLowerOrigArtist[song & 0x7F], xbgmtextsLowerOrigArtistSize[song & 0x7F], 14, NTADR_A(9, 14));
	else one_vram_buffer_horz_repeat('$', 15, NTADR_A(9, 14));
	__A__ = idx16_load_hi_NOC(xbgmtextsUpperOrigArtist, song);
	if (__A__) draw_padded_text(xbgmtextsUpperOrigArtist[song & 0x7F], xbgmtextsUpperOrigArtistSize[song & 0x7F], 14, NTADR_A(9, 13));
	else one_vram_buffer_horz_repeat('$', 15, NTADR_A(9, 13));

	tmp5 = 1;
}	

void update_text3() {
	__A__ = idx16_load_hi_NOC(xbgmtextsUpper, song);
	if (__A__) draw_padded_text(xbgmtextsUpper[song & 0x7F], xbgmtextsUpperSize[song & 0x7F], 14, NTADR_A(9, 7));
	else one_vram_buffer_horz_repeat('$', 15, NTADR_A(9, 7));
	__A__ = idx16_load_hi_NOC(xbgmtextsLower, song);
	if (__A__) draw_padded_text(xbgmtextsLower[song & 0x7F], xbgmtextsLowerSize[song & 0x7F], 14, NTADR_A(9, 8));
	else one_vram_buffer_horz_repeat('$', 15, NTADR_A(9, 8));
}
void update_text2() {
	if (music_queue[0] != 0xFF) one_vram_buffer(0x9F, NTADR_A(1, 13));
	else one_vram_buffer(0xFF, NTADR_A(1, 13));
	for (tmp1 = 0; tmp1 < 2; tmp1++) {			//limited to 5??
		if (music_queue[tmp1] != 0xFF) {
			one_vram_buffer_horz_repeat('$', 27, NTADR_A(3, (13 + (tmp1))));	
			text_stuff();
		}
		else one_vram_buffer_horz_repeat('$', 27, NTADR_A(3, (13 + (tmp1))));	
	}	
	//ppu_on_all();
	tmp4 = 2;
}	





void text_stuff() {
	tmp3 = music_queue[tmp1];
	__A__ = idx16_load_hi_NOC(xbgmtextsUpper, tmp3);
	if (__A__) { 
		multi_vram_buffer_horz(xbgmtextsUpper[tmp3 & 0x7F], xbgmtextsUpperSize[tmp3 & 0x7F], NTADR_A(3, (13 + (tmp1))));
		__A__ = idx16_load_hi_NOC(xbgmtextsLower, tmp3);
		multi_vram_buffer_horz(xbgmtextsLower[tmp3 & 0x7F], xbgmtextsLowerSize[tmp3 & 0x7F], NTADR_A((4 + xbgmtextsUpperSize[tmp3 & 0x7F]), (13 + (tmp1))));
	}
	else {
		__A__ = idx16_load_hi_NOC(xbgmtextsLower, tmp3);
		multi_vram_buffer_horz(xbgmtextsLower[tmp3 & 0x7F], xbgmtextsLowerSize[tmp3 & 0x7F], NTADR_A(3, (13 + (tmp1))));
		one_vram_buffer_horz_repeat('$', 7, NTADR_A((3 + xbgmtextsLowerSize[tmp3 & 0x7F]), (13 + (tmp1))));

	}	
}				
CODE_BANK_POP()
