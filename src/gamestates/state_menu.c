__attribute__((section(".prg_rom_"STR(extra_code_bank)".100")))
const unsigned char pal_title[16]={ 0x11,0x0f,0x10,0x30,0x11,0x0f,0x2a,0x39,0x11,0x01,0x11,0x30,0x11,0x0f,0x21,0x31 };


__attribute__((section(".prg_rom_"STR(extra_code_bank)".101")))
const unsigned char nt_title[349]={
0x02,0x01,0x02,0x3f,0x00,0x02,0x67,0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88,
0x89,0x82,0x83,0x82,0x8b,0x8c,0x8c,0x00,0x02,0x0f,0x90,0x91,0x92,0x93,0x94,0x95,
0x96,0x97,0x98,0x99,0x92,0x93,0x9a,0x9b,0x9c,0x9d,0x00,0x02,0x0f,0xa0,0x00,0xa2,
0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,0xa9,0xa2,0xa3,0xaa,0xab,0xac,0xac,0x00,0x02,0x8f,
0xc8,0xca,0xcc,0xce,0x00,0x00,0xc0,0xc2,0xc4,0xc6,0x00,0x00,0xc8,0xca,0xcc,0xce,
0x00,0x02,0x0f,0xc9,0xcb,0xcd,0xcf,0x00,0x00,0xc1,0xc3,0xc5,0xc7,0x00,0x00,0xd0,
0xd2,0xd4,0xcf,0x00,0x02,0x0f,0xe8,0xea,0xec,0xee,0x00,0x00,0xe0,0xe2,0xe4,0xe6,
0x00,0x00,0xd1,0xd3,0xd5,0xee,0x00,0x02,0x0f,0xe9,0xeb,0xed,0xef,0x00,0x00,0xe1,
0xe3,0xe5,0xe7,0x00,0x00,0xe9,0xeb,0xed,0xef,0x00,0x02,0xc7,0xc0,0xc2,0xc4,0xc6,
0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,
0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xc1,0xc3,0xc5,0xc7,
0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,
0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xd0,0xd2,0xd4,0xd6,
0xd8,0xda,0xdc,0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,0xde,0xd0,0xd2,0xd4,0xd6,
0xd8,0xda,0xdc,0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,0xde,0xd1,0xd3,0xd5,0xd7,
0xd9,0xdb,0xdd,0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,0xdd,0xdf,0xd1,0xd3,0xd5,0xd7,
0xd9,0xdb,0xdd,0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,0xdd,0xdf,0xe0,0xe2,0xe4,0xe6,
0xe8,0xea,0xec,0xee,0xe0,0xe2,0xe4,0xe6,0xe8,0xea,0xec,0xee,0xe0,0xe2,0xe4,0xe6,
0xe8,0xea,0xec,0xee,0xe0,0xe2,0xe4,0xe6,0xe8,0xea,0xec,0xee,0xe1,0xe3,0xe5,0xe7,
0xe9,0xeb,0xed,0xef,0xe1,0xe3,0xe5,0xe7,0xe9,0xeb,0xed,0xef,0xe1,0xe3,0xe5,0xe7,
0xe9,0xeb,0xed,0xef,0xe1,0xe3,0xe5,0xe7,0xe9,0xeb,0xed,0xef,0x01,0x02,0x3f,0x00,
0x02,0x07,0x55,0x02,0x1f,0xaa,0x02,0x0f,0x00,0x02,0x07,0x02,0x00
};


__attribute__((section(".prg_rom_"STR(extra_code_bank)".109")))
void state_menu() {
    //unsigned char option = 0;

    vram_adr(0x000);
    donut_decompress_vram(chr_menu_global, chr_bank_0);
    donut_decompress_vram(chr_font, chr_bank_0);
    donut_decompress_vram(chr_menu_famidash, chr_bank_0);
    set_chr_bank(5,7);
    donut_decompress_vram(chr_menu_buttons, chr_bank_0);
    set_chr_bank(0,8);
    donut_decompress_vram(chr_ground_3, chr_bank_3);

    set_chr_bank(1,7);

    vram_adr(0x2000);
    vram_unrle(nt_title);
    vram_unrle(nt_title);

    pal_bg(pal_title);
    pal_spr(pal_title);
    pal_col(0x17, 0x28);

    setup_advanced_interrupt(
        175, 
        irq_set_chr_and_scroll,
        args88(5,8)
    );
    //third_byte(irq_args) = interrupt_scroll;

    ppu_on_all();
    pal_fade_to(0,4);

    // for some reason, the compiler
    // absolutely REFUSES to put an
    // lda #0 before running this, so
    // do it manually here
    __asm__("lda #0"); 
    music_play(song_menu_theme);

    //automatic_fs_updates=1;
   interrupt_scroll = 0;
    while(1){
        ppu_wait_nmi();
        scroll(0,0);
        oam_clear();

        third_byte(irq_args) = ++interrupt_scroll;
        set_chr_bank(5,7);

        // button sprites
        oam_spr(88, 191, 0xf5, 1);
        oam_spr(96, 191, 0xf7, 1);
        oam_spr(120, 191, 0xf1, 1);
        oam_spr(128, 191, 0xf3, 1);
        oam_spr(152, 191, 0xf9, 1);
        oam_spr(160, 191, 0xfb, 1);


        // the the the the 
        // these are temporary until i implement oam_meta_spr

        // center
        oam_spr(117, 100, 0xd7, 0b00100011);
        oam_spr(131, 100, 0xd7, 0b00100011);

        // left
        oam_spr(71, 101, 0xd7, 0b00100011);
        oam_spr(81, 101, 0xd7, 0b00100011);

        // left
        oam_spr(167, 101, 0xd7, 0b00100011);
        oam_spr(177, 101, 0xd7, 0b00100011);

        // same order but for the bottom
        oam_spr(117, 107, 0xd7, 0b00100011);
        oam_spr(131, 107, 0xd7, 0b00100011);
        oam_spr(71, 105, 0xd7, 0b00100011);
        oam_spr(81, 105, 0xd7, 0b00100011);
        oam_spr(167, 105, 0xd7, 0b00100011);
        oam_spr(177, 105, 0xd7, 0b00100011);

        if(player1_pressed & PAD_A) {
            gamestate = 0x11;
            pal_fade_to(4,0);
            break;
        }

        // this is incredibly basic, but it'll
        // work for the moment. basically, stall
        // until the interrupt...
        //while(irq_count == 0){__asm__ volatile("");}

        // ...then update registers accordingly.
        //set_chr_bank(5,8);
        //PPU.scroll = ++interrupt_scroll;
        //PPU.scroll = interrupt_scroll;
    }
}




__attribute__((section(".prg_rom_"STR(extra_code_bank)".111")))
const unsigned char pal_levelselect[16]={ 0x11,0x01,0x11,0x30,0x11,0x0f,0x2a,0x39,0x11,0x0f,0x10,0x30,0x11,0x0f,0x21,0x31 };


__attribute__((section(".prg_rom_"STR(extra_code_bank)".111")))
const unsigned char nt_levelselect[345]={
0x04,0x01,0x04,0x3f,0x00,0x04,0x05,0x1a,0x1b,0x0e,0x07,0x04,0x03,0x0f,0x0e,0x07,
0x07,0x0f,0x0e,0x07,0x04,0x03,0x0f,0x1a,0x1b,0x00,0x04,0x0d,0x1e,0x17,0x04,0x03,
0x1f,0x14,0x02,0x02,0x15,0x1e,0x17,0x04,0x03,0x1f,0x00,0x04,0x15,0x12,0x11,0x11,
0x13,0x00,0x04,0x73,0x9c,0x06,0x04,0x11,0x9e,0x00,0x04,0x0b,0x06,0x04,0x13,0x00,
0x04,0x0b,0x06,0x04,0x04,0x42,0x52,0x55,0x48,0x06,0x04,0x0a,0x00,0x04,0x0b,0x06,
0x04,0x04,0x4d,0x4f,0x4d,0x45,0x4e,0x54,0x06,0x04,0x08,0x00,0x04,0x0b,0x06,0x04,
0x13,0x00,0x04,0x0b,0x9d,0x06,0x04,0x11,0x9f,0x00,0x04,0x07,0xbc,0x00,0x04,0x19,
0xbe,0x00,0x04,0x03,0xbd,0x00,0x04,0x06,0x4e,0x4f,0x52,0x4d,0x41,0x4c,0x00,0x00,
0x4d,0x4f,0x44,0x45,0x00,0x04,0x06,0xbf,0x00,0x04,0x07,0x08,0x06,0x04,0x11,0x09,
0x00,0x04,0x2e,0x50,0x52,0x41,0x43,0x54,0x49,0x43,0x45,0x00,0x00,0x4d,0x4f,0x44,
0x45,0x00,0x04,0x0e,0x08,0x06,0x04,0x11,0x09,0x00,0x04,0x65,0x10,0x00,0x04,0x1d,
0x10,0x0e,0x0f,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,
0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0x0e,
0x0f,0x1e,0x1f,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,
0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0x1e,
0x1f,0x03,0x03,0x0e,0x0f,0x00,0x00,0xdc,0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,
0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,0xde,0xd0,0xd2,0x00,0x00,0x0e,0x0f,0x03,
0x03,0x02,0x02,0x1e,0x1f,0x10,0x00,0xdd,0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,0xdd,
0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,0xdd,0xdf,0xd1,0xd3,0x00,0x10,0x1e,0x1f,0x02,
0x02,0x01,0x04,0x3f,0xff,0xff,0x5f,0xdf,0x7f,0x5f,0xff,0x04,0x09,0xaa,0xae,0xaa,
0x04,0x03,0xab,0xaa,0xaa,0x5e,0x5a,0x04,0x04,0xa5,0xf5,0x04,0x0f,0x71,0x30,0x00,
0x04,0x03,0xc0,0xd4,0x0f,0x04,0x07,0x04,0x00
};


__attribute__((section(".prg_rom_"STR(extra_code_bank)".119")))
void state_levelselect(){
    ppu_off();
        
    vram_adr(0x800);
    donut_decompress_vram(chr_menu_difficulties, chr_bank_0);
    
    vram_adr(0x2000);
    vram_unrle(nt_levelselect);

    pal_bg(pal_levelselect);

    setup_basic_interrupt(
        0, 
        irq_basic
    );
    set_chr_bank(5,8);

    ppu_on_all();
    pal_fade_to(0,4);

    while(1){
        ppu_wait_nmi();
        //set_chr_bank(5,7);
        oam_clear();

        if(player1_pressed & PAD_B) {
            gamestate = 0x10;
            pal_fade_to(4,0);
            break;
        }

        //while(irq_count == 0){__asm__ volatile("");}
        //set_chr_bank(5,8);
    }
}