__attribute__((section(".prg_rom_"STR(extra_code_bank)".100")))
const unsigned char pal_title[32]={ 
    0x11,0x0f,0x01,0x30,
    0x11,0x0f,0x2a,0x39,
    0x11,0x01,0x11,0x30,
    0x11,0x0f,0x21,0x31,
    
    0x11,0x0f,0x10,0x30,
    0x11,0x0f,0x2a,0x28,
    0x11,0x28,0x17,0x0f,
    0x11,0x0f,0x21,0x31,
};


__attribute__((section(".prg_rom_"STR(extra_code_bank)".101")))
const unsigned char nt_title[374]={
0x02,0x01,0x02,0x3f,0x00,0x02,0x87,0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88,
0x89,0x82,0x83,0x82,0x8b,0x8c,0x8c,0x00,0x02,0x0f,0x90,0x91,0x92,0x93,0x94,0x95,
0x96,0x97,0x98,0x99,0x92,0x93,0x9a,0x9b,0x9c,0x9d,0x00,0x02,0x0f,0xa0,0x8a,0xa2,
0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,0xa9,0xa2,0xa3,0xaa,0xab,0xac,0xac,0x00,0x02,0x0f,
0x8a,0x02,0x0f,0x00,0x02,0x4f,0xc8,0xca,0xcc,0xce,0x00,0x00,0xc0,0xc2,0xc4,0xc6,
0x00,0x00,0xc8,0xca,0xcc,0xce,0x00,0x02,0x0f,0xc9,0xcb,0xcd,0xcf,0x00,0x00,0xc1,
0xc3,0xc5,0xc7,0x00,0x00,0xd0,0xd2,0xd4,0xcf,0x00,0x02,0x0f,0xe8,0xea,0xec,0xee,
0x00,0x00,0xe0,0xe2,0xe4,0xe6,0x00,0x00,0xe8,0xd3,0xd5,0xee,0x00,0x02,0x0f,0xe9,
0xeb,0xed,0xef,0x00,0x00,0xe1,0xe3,0xe5,0xe7,0x00,0x00,0xe9,0xeb,0xed,0xef,0x00,
0x02,0xc7,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,
0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,
0xcc,0xce,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,
0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,
0xcd,0xcf,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,
0xdc,0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,
0xdc,0xde,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,0xdd,0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,
0xdd,0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,0xdd,0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,
0xdd,0xdf,0xe0,0xe2,0xe4,0xe6,0xe8,0xea,0xec,0xee,0xe0,0xe2,0xe4,0xe6,0xe8,0xea,
0xec,0xee,0xe0,0xe2,0xe4,0xe6,0xe8,0xea,0xec,0xee,0xe0,0xe2,0xe4,0xe6,0xe8,0xea,
0xec,0xee,0xe1,0xe3,0xe5,0xe7,0xe9,0xeb,0xed,0xef,0xe1,0xe3,0xe5,0xe7,0xe9,0xeb,
0xed,0xef,0xe1,0xe3,0xe5,0xe7,0xe9,0xeb,0xed,0xef,0xe1,0xe3,0xe5,0xe7,0xe9,0xeb,
0xed,0xef,0x01,0x02,0x3f,0x00,0x02,0x09,0x50,0x02,0x03,0x00,0x02,0x03,0x05,0x02,
0x03,0x00,0x02,0x03,0x55,0x44,0x11,0x55,0x00,0x02,0x09,0xa0,0x02,0x07,0xaa,0x02,
0x07,0x00,0x02,0x07,0x02,0x00
};


__attribute__((section(".prg_rom_"STR(extra_code_bank)".102")))
const uint8_t mspr_title[]={
    // everything in this table is shifted to the left by
    // one pixel due to *the problematic line.*

    // small button sprites
    87, 183, 0xf5, 1,
    95, 183, 0xf7, 1,
    119, 183, 0xf1, 1,
    127, 183, 0xf3, 1, // this line is problematic.
    151, 183, 0xf9, 1,
    159, 183, 0xfb, 1,

    // ROBTOP text
    7, 199, 0x41, 2,  // r/t
    15, 199, 0x43, 2, // o/f
    23, 199, 0x45, 2, // b/d
    31, 199, 0x47, 2, // t/s
    39, 199, 0x49, 2, // o/o
    47, 199, 0x4b, 2, // p/f
    55, 199, 0x4d, 2, //  /t

    // large button sprites (the blue parts)
    // (top)
    116, 100, 0xd7, 0b00100011,
    130, 100, 0xd7, 0b00100011,
    70, 101, 0xd7, 0b00100011,
    80, 101, 0xd7, 0b00100011,
    166, 101, 0xd7, 0b00100011,
    176, 101, 0xd7, 0b00100011,

    // (bottom)
    116, 107, 0xd7, 0b00100011,
    130, 107, 0xd7, 0b00100011,
    70, 105, 0xd7, 0b00100011,
    80, 105, 0xd7, 0b00100011,
    166, 105, 0xd7, 0b00100011,
    176, 105, 0xd7, 0b00100011,
 
    0x80 // end of data
};


__attribute__((section(".prg_rom_"STR(extra_code_bank)".109")))
void state_menu() {
    unsigned char menu_color = 0x11;
    unsigned long interrupt_scroll = 0;

    // load menu stuff
    vram_adr(0x000);
    donut_decompress_vram(chr_menu_global, chr_bank_0);
    donut_decompress_vram(chr_font, chr_bank_0);
    donut_decompress_vram(chr_menu_famidash, chr_bank_0);
    donut_decompress_vram(chr_menu_buttons, chr_bank_0);

    // load ground
    set_chr_bank(0,0x8);
    donut_decompress_vram(chr_g[ground_set], chr_bank_3);
    donut_decompress_vram(chr_menu_robtop, chr_bank_0);

    // load parallax background
    vram_adr(0x1000);
    set_chr_bank(0,0x10);
    set_chr_bank(1,0x12);
    
    if(loaded_bg_set != background_set){
        donut_decompress_vram(chr_bg[background_set], chr_bank_2);
        automatic_fs_updates = 0;
        vram_generate_parallax(background_set);
        loaded_bg_set = background_set;
        automatic_fs_updates = 1;
    }

    // set first sprite bank to the ground
    // the "robtop/tfdsoft" text is there
    set_chr_bank(0,0x8);
    // set second sprite bank to the big buttons
    set_chr_bank(1,0x7);
    
    // set second bg bank to parallax
    set_chr_bank(3,0x10);

    // write the parallax tilemap
    vram_adr(0x2000);
    vram_write_parallax(background_set);

    // write the title screen tilemap
    vram_adr(0x2000);
    vram_unrle_ignore0(nt_title);
    vram_unrle(nt_title);

    

    pal_all(pal_title);

    setup_advanced_interrupt(
        175, 
        irq_set_chr_and_scroll,
        args88(5,8)
    );
    
    // run once before fading in
    oam_meta_spr(1,0,mspr_title);

    ppu_on_all();
    pal_fade_to(0,4);

    // for some reason, the compiler
    // absolutely REFUSES to put an
    // lda #0 before running this, so
    // do it manually here (if song is 0)
    __asm__("lda #0"); 
    music_play(song_menu_theme);

    //automatic_fs_updates=1;
    //interrupt_scroll = 0;
    while(1){
        ppu_wait_nmi();
        scroll(0,0);
        oam_clear();

        interrupt_scroll += phys_speed[1];
        third_byte(irq_args) = high_byte(interrupt_scroll);
        set_chr_bank(5,7);

        // set parallax bank
        set_chr_bank(3,
            ((((uint16_t)(high_byte(interrupt_scroll) | (third_byte(interrupt_scroll)<<8)))>>3)%loaded_bg_width) + 0x10
        );

        if((FRAME_CNT & 0x3F) < 5) {

            if(FRAME_CNT & 0x1) menu_color -= 1;
            else menu_color += 1;

            if(menu_color >= 0x1d) menu_color = 0x11;
            if(menu_color == 0x10) menu_color = 0x1c;

            pal_col(0, menu_color);
            pal_col(2, menu_color-0x10);
            pal_col(9, menu_color-0x10);
            pal_col(10, menu_color);
        }



        
        // the fact that i can use a metasprite for
        // EVERYTHING on the menu is bloody brilliant
        oam_meta_spr(1,0,mspr_title); // one to the right
                                    // so i can put sprites at
                                    // x = 128

        if(player1_pressed & PAD_A) {
            gamestate = 0x11;
            pal_fade_to(4,0);
            break;
        }

    }
}






__attribute__((section(".prg_rom_"STR(extra_code_bank)".110")))
const unsigned char pal_levelselect[16]={ 0x11,0x01,0x11,0x30,0x11,0x0f,0x2a,0x39,0x11,0x0f,0x10,0x30,0x11,0x0f,0x21,0x31 };


__attribute__((section(".prg_rom_"STR(extra_code_bank)".111")))
const unsigned char nt_levelselect[345]={
0x04,0x01,0x04,0x3f,0x00,0x04,0x05,0x1a,0x1b,0x0e,0x07,0x04,0x03,0x0f,0x0e,0x07,
0x07,0x0f,0x0e,0x07,0x04,0x03,0x0f,0x1a,0x1b,0x00,0x04,0x0d,0x1e,0x17,0x04,0x03,
0x1f,0x14,0x02,0x02,0x15,0x1e,0x17,0x04,0x03,0x1f,0x00,0x04,0x15,0x12,0x11,0x11,
0x13,0x00,0x04,0x73,0x9c,0x06,0x04,0x11,0x9e,0x00,0x04,0x0b,0x06,0x04,0x13,0x00,
0x04,0x0b,0x06,0x04,0x04,0x42,0x52,0x55,0x48,0x06,0x04,0x0a,0x00,0x04,0x0b,0x06,
0x04,0x04,0x4d,0x4f,0x4d,0x45,0x4e,0x54,0x06,0x04,0x08,0x00,0x04,0x0b,0x06,0x04,
0x13,0x00,0x04,0x0b,0x9d,0x06,0x04,0x11,0x9f,0x00,0x04,0x07,0xbc,0x00,0x04,0x19,
0xbe,0x00,0x04,0x03,0xbd,0x00,0x04,0x06,0x4e,0x4f,0x52,0x4d,0x41,0x4c,0x00,0x00,
0x4d,0x4f,0x44,0x45,0x00,0x04,0x06,0xbf,0x00,0x04,0x07,0x08,0x06,0x04,0x11,0x09,
0x00,0x04,0x2e,0x50,0x52,0x41,0x43,0x54,0x49,0x43,0x45,0x00,0x00,0x4d,0x4f,0x44,
0x45,0x00,0x04,0x0e,0x08,0x06,0x04,0x11,0x09,0x00,0x04,0x65,0x10,0x00,0x04,0x1d,
0x10,0x0e,0x0f,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,
0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0xcc,0xce,0xc0,0xc2,0xc4,0xc6,0xc8,0xca,0x0e,
0x0f,0x1e,0x1f,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,
0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0x1e,
0x1f,0x03,0x03,0x0e,0x0f,0x00,0x00,0xdc,0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,
0xde,0xd0,0xd2,0xd4,0xd6,0xd8,0xda,0xdc,0xde,0xd0,0xd2,0x00,0x00,0x0e,0x0f,0x03,
0x03,0x02,0x02,0x1e,0x1f,0x10,0x00,0xdd,0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,0xdd,
0xdf,0xd1,0xd3,0xd5,0xd7,0xd9,0xdb,0xdd,0xdf,0xd1,0xd3,0x00,0x10,0x1e,0x1f,0x02,
0x02,0x01,0x04,0x3f,0xff,0xff,0x5f,0xdf,0x7f,0x5f,0xff,0x04,0x09,0xaa,0xae,0xaa,
0x04,0x03,0xab,0xaa,0xaa,0x5e,0x5a,0x04,0x04,0xa5,0xf5,0x04,0x0f,0x71,0x30,0x00,
0x04,0x03,0xc0,0xd4,0x0f,0x04,0x07,0x04,0x00
};


__attribute__((section(".prg_rom_"STR(extra_code_bank)".119")))
void state_levelselect(){
    ppu_off();
        
    vram_adr(0x800);
    donut_decompress_vram(chr_menu_difficulties, chr_bank_0);
    
    vram_adr(0x2000);
    vram_unrle(nt_levelselect);

    pal_bg(pal_levelselect);

    setup_basic_interrupt(
        0, 
        irq_basic
    );
    set_chr_bank(5,8);

    ppu_on_all();
    pal_fade_to(0,4);

    while(1){
        ppu_wait_nmi();
        //set_chr_bank(5,7);
        oam_clear();

        if(player1_pressed & PAD_B) {
            gamestate = 0x10;
            pal_fade_to(4,0);
            break;
        }

        //while(irq_count == 0){__asm__ volatile("");}
        //set_chr_bank(5,8);
    }
}