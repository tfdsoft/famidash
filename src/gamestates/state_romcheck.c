putinbank(extra_code_bank.ramcheck.00)
const unsigned char pal_grayscale[] = {
    0x0f, 0x00, 0x10, 0x20,
    0x0f, 0x05, 0x16, 0x26,
    0x0f, 0x09, 0x19, 0x29,
    0x0f, 0x01, 0x11, 0x21,
};

putinbank(extra_code_bank.ramcheck.01)
const unsigned char nt_ramcheck[259]={
0x01,0x00,0x01,0xc3,0x54,0x48,0x49,0x53,0x00,0x45,0x4d,0x55,0x4c,0x41,0x54,0x4f,
0x52,0x2f,0x43,0x41,0x52,0x54,0x52,0x49,0x44,0x47,0x45,0x00,0x01,0x08,0x49,0x53,
0x00,0x4e,0x4f,0x54,0x00,0x53,0x55,0x50,0x50,0x4f,0x52,0x54,0x45,0x44,0x2e,0x00,
0x01,0x4f,0x20,0x52,0x41,0x4d,0x00,0x50,0x52,0x45,0x53,0x45,0x4e,0x54,0x3a,0x00,
0x01,0x03,0x20,0x01,0x02,0x4b,0x42,0x00,0x01,0x29,0x20,0x52,0x41,0x4d,0x00,0x52,
0x45,0x51,0x55,0x49,0x52,0x45,0x44,0x3a,0x00,0x01,0x02,0x20,0x01,0x02,0x4b,0x42,
0x00,0x01,0x68,0x49,0x46,0x00,0x55,0x53,0x49,0x4e,0x47,0x00,0x41,0x4e,0x00,0x45,
0x4d,0x55,0x4c,0x41,0x54,0x4f,0x52,0x3a,0x00,0x01,0x0a,0x50,0x4c,0x45,0x41,0x53,
0x45,0x00,0x55,0x53,0x45,0x00,0x4d,0x45,0x53,0x45,0x4e,0x32,0x2e,0x00,0x01,0x2d,
0x4e,0x45,0x53,0x54,0x4f,0x50,0x49,0x41,0x2c,0x00,0x41,0x53,0x00,0x57,0x45,0x4c,
0x4c,0x00,0x41,0x53,0x00,0x41,0x4e,0x59,0x00,0x01,0x07,0x45,0x4d,0x55,0x4c,0x41,
0x54,0x4f,0x52,0x53,0x00,0x42,0x41,0x53,0x45,0x44,0x00,0x4f,0x46,0x46,0x00,0x49,
0x54,0x2c,0x00,0x01,0x08,0x4c,0x41,0x43,0x4b,0x00,0x54,0x48,0x45,0x00,0x46,0x45,
0x41,0x54,0x55,0x52,0x45,0x53,0x00,0x4e,0x45,0x45,0x44,0x45,0x44,0x00,0x01,0x07,
0x54,0x4f,0x00,0x52,0x55,0x4e,0x00,0x54,0x48,0x49,0x53,0x00,0x47,0x41,0x4d,0x45,
0x2e,0x00,0x01,0xea,0x55,0x01,0x10,0x20,0x02,0x01,0x07,0xf0,0x01,0x08,0x00,0x01,
0x1c,0x01,0x00
};

putinbank(extra_code_bank.ramcheck.02)
const unsigned char dat_ramtype[] = {
    'V',
    'N',
    'W'
};

putinbank(extra_code_bank.ramcheck.03)
const char str_ramcount[][4] = {
    "  1",
    "  2",
    "  4",
    "  8",
    " 16",
    " 32",
    " 64",
    "128",
};

putinbank(extra_code_bank.ramcheck.06)
unsigned char check_vram_amount(){
    unsigned char bank = 0;

    // write the value
    vram_adr(0);
    set_chr_mode_2(0);
    PPU.vram.data = 0x55;

    do {
        set_chr_mode_3((1 << bank));

        vram_adr(0x400);
        PPU.vram.data; // prime read
        if(PPU.vram.data == 0x55) break;

        bank++;
    } while (bank != 6);
    return bank;
}


putinbank(extra_code_bank.ramcheck.09)
void state_ramcheck(){
    unsigned char type,ramcount,ramneeded;

    type = 0;
    ramcount = check_vram_amount();
    ramneeded = 6;
    // first, test chr-ram.
    if (ramcount != ramneeded) {
        __attribute__((leaf)) __asm__ volatile(
            "jmp ramcheck_failed"
        );
    }

    //type = 1;
    // test nametable ram here

    //type = 2;
    // test save ram here



    __attribute__((leaf)) __asm__ volatile(
        "rts \n"
        "ramcheck_failed: \n"
    );
    set_chr_mode_2(4);
    set_chr_mode_3(5);

    pal_bg(pal_grayscale);

    vram_adr(0x2000);
    vram_unrle(nt_ramcheck);

    one_vram_buffer(dat_ramtype[type], 0x2145);
    one_vram_buffer(dat_ramtype[type], 0x2185);

    str_vram_buffer(str_ramcount[ramcount], 0x2156);
    str_vram_buffer(str_ramcount[ramneeded], 0x2196);

    vram_adr(0x0200);
    donut_decompress_vram(chr_font, chr_bank_0);

    ppu_on_all();
    pal_fade_to(0,4);
    while(1){
        ppu_wait_nmi();

    }
}
